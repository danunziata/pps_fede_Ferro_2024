---

apiVersion: v1
kind: ConfigMap
metadata:
 name: telegraf-config-input
data:
 telegraf.conf: |
  [global_tags]
  project = "iotcrashcourse"

  [agent]
    interval = "10s"
    round_interval = true
    metric_batch_size = 1000
    metric_buffer_limit = 10000
    collection_jitter = "0s"
    flush_interval = "10s"
    flush_jitter = "0s"
    precision = "0s"
    hostname = "telegrafinput"
    omit_hostname = false

  [[inputs.tail]]
    files = ["/tmp/ouput_mock_sensor.json"]
    data_format = "json"

    tag_keys = [
      "device_id",
      "client_id"
    ]

    json_name_key = "sensor_type"
    json_time_key = "timestamp"
    json_time_format = "unix"


  [[outputs.mqtt]]
    servers = ["${MINIKUBEIP}:31003"]
    topic_prefix = "telegraf"
    qos = 2
    data_format = "influx"
    retain = true

---

apiVersion: v1
kind: ConfigMap
metadata:
 name: telegraf-config-output
data:
 telegraf.conf: |
  [global_tags]
    project = "iotcrashcourse"

  [agent]
    interval = "10s"
    round_interval = true
    metric_batch_size = 1000
    metric_buffer_limit = 10000
    collection_jitter = "0s"
    flush_interval = "10s"
    flush_jitter = "0s"
    precision = "0s"
    hostname = "telegrafoutput"
    omit_hostname = false

  [[inputs.mqtt_consumer]]
    servers = ["${MINIKUBEIP}:31003"]
    topics = [
      "telegraf/telegrafinput/#"
    ]
    qos = 2

  [[outputs.influxdb_v2]]
    urls = ["http://${MINIKUBEIP}:31001"]
    token = "labredes-iotdata-auth-token"
    organization = "labredes"
    bucket = "iotdata"